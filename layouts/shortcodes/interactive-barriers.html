{{/* Interactive Barrier State Table â€” step through passes and watch barriers fire */}}
<div class="interactive-widget" id="barrier-widget">
  <div class="widget-header">
    <span class="widget-icon">ðŸ”¬</span>
    <span class="widget-title">Interactive: Automatic Barrier Insertion</span>
    <p class="widget-hint">Step through execution. Watch resource states change and barriers fire automatically.</p>
  </div>
  <div class="widget-body">
    <div class="barrier-example-bar">
      <span class="barrier-example-label">Example:</span>
      <button class="widget-btn barrier-ex-btn barrier-ex-active" data-ex="0" onclick="barrierSetExample(0)">Deferred Pipeline</button>
      <button class="widget-btn barrier-ex-btn" data-ex="1" onclick="barrierSetExample(1)">Compute Post-FX</button>
      <button class="widget-btn barrier-ex-btn" data-ex="2" onclick="barrierSetExample(2)">Shadow + Forward</button>
    </div>
    <div class="barrier-pass-bar" id="barrier-passes"></div>
    <table class="barrier-table">
      <thead>
        <tr>
          <th>Resource</th>
          <th>Format</th>
          <th>Current State</th>
          <th>Barrier</th>
        </tr>
      </thead>
      <tbody id="barrier-tbody"></tbody>
    </table>
    <div class="barrier-log" id="barrier-log"></div>
    <div class="widget-btn-row">
      <button class="widget-btn widget-btn-primary" id="barrier-next" onclick="barrierNext()">Next Pass â–¶</button>
      <button class="widget-btn" onclick="barrierReset()">Reset</button>
    </div>
  </div>
</div>

<style>
.barrier-pass-bar{display:flex;gap:.35em;margin-bottom:1em;flex-wrap:wrap}
.barrier-pass-pill{padding:.3em .7em;border-radius:.375rem;font-family:ui-monospace,monospace;font-size:.78em;font-weight:600;border:2px solid transparent;background:var(--color-neutral-200,#e5e5e5);color:var(--color-neutral-600)}
:is(.dark,.scheme-congo) .barrier-pass-pill{background:var(--color-neutral-700);color:var(--color-neutral-300)}
.barrier-pass-pill.done{background:var(--ds-success);color:#fff;border-color:var(--ds-success-dark)}
.barrier-pass-pill.current{background:var(--ds-info);color:#fff;border-color:var(--ds-info-dark);animation:bpulse .8s ease-in-out infinite alternate}
@keyframes bpulse{to{box-shadow:0 0 8px rgba(var(--ds-info-rgb),.5)}}
.barrier-table{width:100%;border-collapse:collapse;font-family:ui-monospace,monospace;font-size:.8em;margin:.75em 0}
.barrier-table th{text-align:left;padding:.35em .5em;border-bottom:2px solid var(--color-neutral-300,#d4d4d4);font-size:.75em;text-transform:uppercase;letter-spacing:.05em;opacity:.7}
:is(.dark,.scheme-congo) .barrier-table th{border-color:var(--color-neutral-600)}
.barrier-table td{padding:.4em .5em;border-bottom:1px solid var(--color-neutral-200,#e5e5e5);transition:background .3s}
:is(.dark,.scheme-congo) .barrier-table td{border-color:var(--color-neutral-700)}
.barrier-table tr.transition td{background:rgba(var(--ds-info-rgb),.12)}
.barrier-table .state-badge{display:inline-block;padding:.15em .5em;border-radius:.25rem;font-weight:600;font-size:.9em}
.state-undefined{background:#6b7280;color:#fff}
.state-color{background:var(--ds-success);color:#fff}
.state-depth{background:var(--ds-code);color:#fff}
.state-shader{background:var(--ds-warn);color:#fff}
.state-present{background:var(--ds-danger);color:#fff}
.barrier-arrow{font-weight:700;color:var(--ds-info);margin:0 .3em}
.barrier-log{font-family:ui-monospace,monospace;font-size:.78em;max-height:120px;overflow-y:auto;padding:.5em;margin:.5em 0;border:1px solid var(--color-neutral-200,#e5e5e5);border-radius:.375rem;background:var(--color-neutral-100,#f5f5f5)}
:is(.dark,.scheme-congo) .barrier-log{background:var(--color-neutral-900);border-color:var(--color-neutral-700)}
.barrier-log-entry{margin:.2em 0;line-height:1.5}
.barrier-log-entry.barrier-fired{color:var(--ds-info);font-weight:600}
.barrier-example-bar{display:flex;align-items:center;gap:.5em;margin-bottom:.75em;flex-wrap:wrap}
.barrier-example-label{font-size:.82em;font-weight:700;color:var(--color-neutral-500)}
.barrier-ex-btn{font-size:.78em!important;padding:.35em .9em!important;border-radius:999px!important;font-weight:600!important}
.barrier-ex-active{background:var(--ds-info)!important;color:#fff!important;border-color:var(--ds-info)!important;box-shadow:0 0 0 2px rgba(var(--ds-info-rgb),.25)!important}
</style>

<script>
(function(){
var EXAMPLES=[
  {
    name:"Deferred Pipeline",
    resources:[
      {name:"depth",fmt:"D32F"},
      {name:"gbufAlbedo",fmt:"RGBA8"},
      {name:"gbufNormals",fmt:"RGBA8"},
      {name:"ssaoResult",fmt:"R8"},
      {name:"hdr",fmt:"RGBA16F"},
      {name:"backbuffer",fmt:"RGBA8"}
    ],
    passOrder:[
      {name:"DepthPrepass",writes:[0],reads:[],desc:"Writes depth buffer"},
      {name:"GBuffer",reads:[0],writes:[1,2],desc:"Reads depth, writes albedo + normals"},
      {name:"SSAO",reads:[2],writes:[3],desc:"Reads normals, writes SSAO result"},
      {name:"Lighting",reads:[1,2,3],writes:[4],desc:"Reads albedo + normals + SSAO, writes HDR"},
      {name:"Tonemap",reads:[4],writes:[5],desc:"Reads HDR, writes backbuffer"},
      {name:"Present",reads:[5],writes:[],desc:"Present backbuffer to screen"}
    ]
  },
  {
    name:"Compute Post-FX",
    resources:[
      {name:"sceneColor",fmt:"RGBA16F"},
      {name:"bloomDownA",fmt:"RGBA16F"},
      {name:"bloomDownB",fmt:"RGBA16F"},
      {name:"bloomResult",fmt:"RGBA16F"},
      {name:"backbuffer",fmt:"RGBA8"}
    ],
    passOrder:[
      {name:"SceneRender",writes:[0],reads:[],desc:"Render scene to HDR color"},
      {name:"BloomDown1",reads:[0],writes:[1],desc:"Compute: downsample to half-res"},
      {name:"BloomDown2",reads:[1],writes:[2],desc:"Compute: downsample to quarter-res"},
      {name:"BloomUp",reads:[2],writes:[3],desc:"Compute: upsample + merge bloom"},
      {name:"Composite",reads:[0,3],writes:[4],desc:"Blend scene + bloom to backbuffer"},
      {name:"Present",reads:[4],writes:[],desc:"Present backbuffer"}
    ]
  },
  {
    name:"Shadow + Forward",
    resources:[
      {name:"shadowMap",fmt:"D32F"},
      {name:"depth",fmt:"D32F"},
      {name:"color",fmt:"RGBA16F"},
      {name:"backbuffer",fmt:"RGBA8"}
    ],
    passOrder:[
      {name:"ShadowPass",writes:[0],reads:[],desc:"Render shadow depth map"},
      {name:"DepthPrepass",writes:[1],reads:[],desc:"Render scene depth"},
      {name:"Forward",reads:[0,1],writes:[2],desc:"Forward shading with shadow lookup"},
      {name:"Tonemap",reads:[2],writes:[3],desc:"Tonemap HDR to LDR"},
      {name:"Present",reads:[3],writes:[],desc:"Present backbuffer"}
    ]
  }
];

var curExIdx=0;
var resources,passOrder;

function loadExample(idx){
  curExIdx=idx;
  var ex=EXAMPLES[idx];
  resources=ex.resources.map(function(r){return{name:r.name,fmt:r.fmt,state:"Undefined"}});
  passOrder=ex.passOrder;
  document.querySelectorAll('.barrier-ex-btn').forEach(function(b){
    b.classList.toggle('barrier-ex-active',parseInt(b.dataset.ex)===idx);
  });
  init();
}

function stateFor(isWrite,fmt){
  if(!isWrite)return"ShaderRead";
  if(fmt==="D32F")return"DepthAttachment";
  return"ColorAttachment";
}
function stateClass(s){
  if(s==="Undefined")return"state-undefined";
  if(s.includes("Color"))return"state-color";
  if(s.includes("Depth"))return"state-depth";
  if(s.includes("Shader"))return"state-shader";
  if(s==="Present")return"state-present";
  return"state-undefined";
}
function apiCall(oldS,newS){
  const vk={
    "Undefinedâ†’DepthAttachment":"vkCmdPipelineBarrier: TOP_OF_PIPE â†’ EARLY_FRAGMENT_TESTS",
    "Undefinedâ†’ColorAttachment":"vkCmdPipelineBarrier: TOP_OF_PIPE â†’ COLOR_ATTACHMENT_OUTPUT",
    "DepthAttachmentâ†’ShaderRead":"vkCmdPipelineBarrier: LATE_FRAGMENT_TESTS â†’ FRAGMENT_SHADER",
    "ColorAttachmentâ†’ShaderRead":"vkCmdPipelineBarrier: COLOR_ATTACHMENT_OUTPUT â†’ FRAGMENT_SHADER",
    "ShaderReadâ†’ColorAttachment":"vkCmdPipelineBarrier: FRAGMENT_SHADER â†’ COLOR_ATTACHMENT_OUTPUT",
    "Undefinedâ†’ShaderRead":"vkCmdPipelineBarrier: TOP_OF_PIPE â†’ FRAGMENT_SHADER",
    "ColorAttachmentâ†’Present":"vkCmdPipelineBarrier: COLOR_ATTACHMENT_OUTPUT â†’ BOTTOM_OF_PIPE"
  };
  return vk[oldS+"â†’"+newS]||"barrier: "+oldS+" â†’ "+newS;
}

let currentStep,logEntries,transitions;

function init(){
  resources.forEach(function(r){r.state="Undefined"});
  currentStep=-1;logEntries=[];transitions={};
  renderPasses();renderTable();renderLog();
  document.getElementById("barrier-next").disabled=false;
}

function renderPasses(){
  const bar=document.getElementById("barrier-passes");
  bar.innerHTML="";
  passOrder.forEach((p,i)=>{
    const pill=document.createElement("span");
    pill.className="barrier-pass-pill"+(i<currentStep?" done":"")+(i===currentStep?" current":"");
    pill.textContent=p.name;
    bar.append(pill);
  });
}

function renderTable(){
  const tbody=document.getElementById("barrier-tbody");
  tbody.innerHTML="";
  resources.forEach((r,i)=>{
    const tr=document.createElement("tr");
    if(transitions[i])tr.className="transition";
    const tdName=document.createElement("td");tdName.textContent=r.name;
    const tdFmt=document.createElement("td");tdFmt.textContent=r.fmt;
    const tdState=document.createElement("td");
    const badge=document.createElement("span");
    badge.className="state-badge "+stateClass(r.state);
    badge.textContent=r.state;
    tdState.append(badge);
    const tdBarrier=document.createElement("td");
    if(transitions[i]){
      tdBarrier.innerHTML=`<span class="state-badge ${stateClass(transitions[i].from)}">${transitions[i].from}</span>`+
        `<span class="barrier-arrow">â†’</span>`+
        `<span class="state-badge ${stateClass(transitions[i].to)}">${transitions[i].to}</span>`;
    }else{
      tdBarrier.textContent="â€”";
    }
    tr.append(tdName,tdFmt,tdState,tdBarrier);
    tbody.append(tr);
  });
}

function renderLog(){
  const log=document.getElementById("barrier-log");
  log.innerHTML=logEntries.length?logEntries.map(e=>`<div class="barrier-log-entry${e.barrier?" barrier-fired":""}">${e.text}</div>`).join(""):"<em>Step through passes to see barriers.</em>";
  log.scrollTop=log.scrollHeight;
}

window.barrierNext=function(){
  currentStep++;
  if(currentStep>=passOrder.length){
    document.getElementById("barrier-next").disabled=true;
    logEntries.push({text:"âœ“ Frame complete. "+logEntries.filter(e=>e.barrier).length+" barriers inserted automatically.",barrier:false});
    transitions={};renderPasses();renderTable();renderLog();return;
  }
  const pass=passOrder[currentStep];
  transitions={};
  logEntries.push({text:`â”€â”€ ${pass.name}: ${pass.desc}`,barrier:false});

  // Process reads
  pass.reads.forEach(ri=>{
    const needed=stateFor(false,resources[ri].fmt);
    if(resources[ri].state!==needed){
      const old=resources[ri].state;
      transitions[ri]={from:old,to:needed};
      logEntries.push({text:`  âš¡ barrier: ${resources[ri].name} ${old} â†’ ${needed}`,barrier:true});
      logEntries.push({text:`    ${apiCall(old,needed)}`,barrier:false});
      resources[ri].state=needed;
    }
  });
  // Process writes
  pass.writes.forEach(wi=>{
    const needed=currentStep===5?"Present":stateFor(true,resources[wi].fmt);
    if(resources[wi].state!==needed){
      const old=resources[wi].state;
      transitions[wi]={from:old,to:needed};
      logEntries.push({text:`  âš¡ barrier: ${resources[wi].name} ${old} â†’ ${needed}`,barrier:true});
      logEntries.push({text:`    ${apiCall(old,needed)}`,barrier:false});
      resources[wi].state=needed;
    }
  });

  renderPasses();renderTable();renderLog();
};

window.barrierReset=function(){loadExample(curExIdx)};
window.barrierSetExample=loadExample;
loadExample(0);
})();
</script>
