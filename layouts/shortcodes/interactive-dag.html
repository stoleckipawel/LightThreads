{{/* Interactive DAG + Pass Culling â€” click edges to toggle, see dead passes culled */}}
<div class="interactive-widget" id="dag-widget">
  <div class="widget-header">
    <span class="widget-icon">ðŸ”¬</span>
    <span class="widget-title">Interactive: DAG &amp; Pass Culling</span>
    <p class="widget-hint">Click any edge to disable it. Passes that can't reach the output are automatically culled.</p>
  </div>
  <div class="widget-body">
    <div class="dag-example-bar" id="dag-example-bar">
      <span class="dag-example-label">Example:</span>
      <button class="widget-btn dag-ex-btn dag-ex-active" data-ex="0" onclick="dagSetExample(0)">Deferred Shading</button>
      <button class="widget-btn dag-ex-btn" data-ex="1" onclick="dagSetExample(1)">Shadow + Bloom</button>
      <button class="widget-btn dag-ex-btn" data-ex="2" onclick="dagSetExample(2)">Forward + TAA</button>
    </div>
    <svg id="dag-svg" viewBox="0 0 640 300" xmlns="http://www.w3.org/2000/svg"></svg>
    <div class="widget-info" id="dag-info">
      <div><strong>Topological order:</strong> <span id="dag-topo">â€”</span></div>
      <div><strong>Active:</strong> <span id="dag-active">5</span> / <span id="dag-total">5</span> passes</div>
    </div>
    <div class="dag-explain" id="dag-explain"></div>
    <button class="widget-btn" onclick="dagReset()">Reset Edges</button>
  </div>
</div>

<style>
.interactive-widget{margin:1.5em 0;border:2px solid var(--color-neutral-300,#d4d4d4);border-radius:.75rem;overflow:hidden;background:var(--color-neutral-50,#fafafa);box-shadow:0 2px 12px rgba(0,0,0,.06)}
:is(.dark,.scheme-congo) .interactive-widget{background:var(--color-neutral-800,#262626);border-color:var(--color-neutral-600,#525252);box-shadow:0 2px 16px rgba(0,0,0,.25)}
.widget-header{padding:.75em 1em .4em;border-bottom:1px solid var(--color-neutral-200,#e5e5e5);border-top:3px solid var(--ds-info);background:linear-gradient(180deg,rgba(var(--ds-info-rgb),.04),transparent)}
:is(.dark,.scheme-congo) .widget-header{border-color:var(--color-neutral-700);border-top-color:var(--ds-info);background:linear-gradient(180deg,rgba(var(--ds-info-rgb),.08),transparent)}
.widget-icon{font-size:1.2em;margin-right:.3em}
.widget-title{font-weight:700;font-size:.95em}
.widget-hint{margin:.4em 0 .15em;font-size:.82em;line-height:1.55;color:var(--color-neutral-600,#4b5563)}
:is(.dark,.scheme-congo) .widget-hint{color:var(--color-neutral-400)}
.widget-body{padding:1em}
.widget-info{font-family:ui-monospace,SFMono-Regular,monospace;font-size:.82em;margin:.5em 0;line-height:1.7}
.widget-btn{font-size:.8em;padding:.4em 1em;border:1.5px solid var(--color-neutral-300,#d1d5db);border-radius:.375rem;background:var(--color-neutral-100,#f5f5f5);cursor:pointer;color:var(--color-neutral-700,#374151);font-weight:500;transition:all .15s}
.widget-btn:hover{background:var(--color-neutral-200,#e5e5e5);border-color:var(--color-neutral-400)}
:is(.dark,.scheme-congo) .widget-btn{background:var(--color-neutral-700,#404040);border-color:var(--color-neutral-600);color:var(--color-neutral-200)}
:is(.dark,.scheme-congo) .widget-btn:hover{background:var(--color-neutral-600);border-color:var(--color-neutral-500)}
.dag-explain{font-size:.84em;line-height:1.65;margin:.5em 0;padding:.5em .8em;border-radius:.375rem;border-left:3px solid var(--ds-info);background:var(--color-neutral-100,#f5f5f5);min-height:1.5em}
:is(.dark,.scheme-congo) .dag-explain{background:var(--color-neutral-900);border-color:var(--ds-info)}
.dag-example-bar{display:flex;align-items:center;gap:.5em;margin-bottom:.75em;flex-wrap:wrap}
.dag-example-label{font-size:.82em;font-weight:700;opacity:.6}
.dag-ex-btn{font-size:.78em!important;padding:.35em .9em!important;border-radius:999px!important;font-weight:600!important}
.dag-ex-active{background:var(--ds-info)!important;color:#fff!important;border-color:var(--ds-info)!important;box-shadow:0 0 0 2px rgba(var(--ds-info-rgb),.25)!important}
#dag-svg{width:100%;max-height:320px;display:block;margin:0 auto}
#dag-svg .node rect{rx:8;ry:8;stroke-width:2;cursor:default;transition:fill .2s,stroke .2s,opacity .2s}
#dag-svg .node text{font:600 12px ui-monospace,SFMono-Regular,monospace;fill:#fff;pointer-events:none;text-anchor:middle;dominant-baseline:central}
#dag-svg .edge{cursor:pointer}
#dag-svg .edge path{fill:none;stroke-width:3;transition:stroke .2s,opacity .2s}
#dag-svg .edge polygon{transition:fill .2s,opacity .2s}
#dag-svg .edge-label{font:500 10px system-ui,sans-serif;pointer-events:none;text-anchor:middle;dominant-baseline:central;transition:fill .2s,opacity .2s}
#dag-svg .edge-hit{fill:transparent;stroke:transparent;stroke-width:22;cursor:pointer}
</style>

<script>
(function(){
const NW=100,NH=34;
const COL_ALIVE="var(--ds-success)",COL_DEAD="#6b7280",COL_OUTPUT="var(--ds-warn)",COL_EDGE="var(--ds-info)",COL_OFF="#9ca3af";

const EXAMPLES=[
  {
    name:"Deferred Shading",
    passes:[
      {id:0,name:"Depth",x:50,y:40},
      {id:1,name:"GBuffer",x:220,y:40},
      {id:2,name:"SSAO",x:420,y:40},
      {id:3,name:"Lighting",x:300,y:140},
      {id:4,name:"Tonemap",x:300,y:240}
    ],
    edges:[
      {from:0,to:1,label:"depth"},
      {from:1,to:2,label:"normals"},
      {from:1,to:3,label:"albedo"},
      {from:2,to:3,label:"ssao"},
      {from:3,to:4,label:"hdr"}
    ],
    outputId:4
  },
  {
    name:"Shadow + Bloom",
    passes:[
      {id:0,name:"Shadows",x:50,y:40},
      {id:1,name:"GBuffer",x:50,y:140},
      {id:2,name:"Lighting",x:250,y:90},
      {id:3,name:"Bloom",x:440,y:40},
      {id:4,name:"Tonemap",x:440,y:140},
      {id:5,name:"Present",x:340,y:240}
    ],
    edges:[
      {from:0,to:2,label:"shadow map"},
      {from:1,to:2,label:"albedo+norm"},
      {from:2,to:3,label:"hdr"},
      {from:2,to:4,label:"hdr"},
      {from:3,to:4,label:"bloom"},
      {from:4,to:5,label:"ldr"}
    ],
    outputId:5
  },
  {
    name:"Forward + TAA",
    passes:[
      {id:0,name:"Depth",x:50,y:130},
      {id:1,name:"Forward",x:210,y:50},
      {id:2,name:"Sky",x:210,y:210},
      {id:3,name:"TAA",x:390,y:130},
      {id:4,name:"Tonemap",x:540,y:130}
    ],
    edges:[
      {from:0,to:1,label:"depth"},
      {from:0,to:2,label:"depth"},
      {from:1,to:3,label:"color"},
      {from:2,to:3,label:"sky"},
      {from:3,to:4,label:"resolved"}
    ],
    outputId:4
  }
];

let curExample=0;
let passes,edges,outputId;

function loadExample(idx){
  curExample=idx;
  const ex=EXAMPLES[idx];
  passes=ex.passes.map(p=>({...p}));
  edges=ex.edges.map(e=>({...e,active:true}));
  outputId=ex.outputId;
  // Update button styles
  document.querySelectorAll('.dag-ex-btn').forEach(b=>{
    b.classList.toggle('dag-ex-active',parseInt(b.dataset.ex)===idx);
  });
  // Update viewBox based on layout
  const maxX=Math.max(...passes.map(p=>p.x))+NW+30;
  const maxY=Math.max(...passes.map(p=>p.y))+NH+30;
  document.getElementById('dag-svg').setAttribute('viewBox',`0 0 ${maxX} ${maxY}`);
  document.getElementById('dag-total').textContent=passes.length;
  render();
}

function cx(p){return p.x+NW/2}
function cy(p){return p.y+NH/2}

function topoSort(){
  const adj={},inDeg={};
  passes.forEach(p=>{adj[p.id]=[];inDeg[p.id]=0});
  edges.filter(e=>e.active).forEach(e=>{adj[e.from].push(e.to);inDeg[e.to]++});
  const q=passes.filter(p=>inDeg[p.id]===0).map(p=>p.id);
  const order=[];let i=0;
  while(i<q.length){const c=q[i++];order.push(c);adj[c].forEach(s=>{if(--inDeg[s]===0)q.push(s)})}
  return order;
}

function cull(order){
  const alive=new Set();
  if(order.length===0)return alive;
  if(!order.includes(outputId))return alive;
  alive.add(outputId);
  const rev={};passes.forEach(p=>rev[p.id]=[]);
  edges.filter(e=>e.active).forEach(e=>rev[e.to].push(e.from));
  const stack=[outputId];
  while(stack.length){
    const c=stack.pop();
    rev[c].forEach(p=>{if(!alive.has(p)){alive.add(p);stack.push(p)}});
  }
  return alive;
}

function edgePath(e){
  const s=passes.find(p=>p.id===e.from),d=passes.find(p=>p.id===e.to);
  const sx=cx(s),sy=cy(s),dx=cx(d),dy=cy(d);
  const ang=Math.atan2(dy-sy,dx-sx);
  const x1=sx+Math.cos(ang)*(NW/2+2),y1=sy+Math.sin(ang)*(NH/2+2);
  const x2=dx-Math.cos(ang)*(NW/2+8),y2=dy-Math.sin(ang)*(NH/2+8);
  const mx=(x1+x2)/2,my=(y1+y2)/2;
  const nx=-(y2-y1)*.12,ny=(x2-x1)*.12;
  return{x1,y1,x2,y2,mx:mx+nx,my:my+ny,
    d:`M${x1},${y1} Q${mx+nx},${my+ny} ${x2},${y2}`};
}

function arrowHead(x2,y2,mx,my){
  const ang=Math.atan2(y2-my,x2-mx);
  const sz=8;
  const p1x=x2-sz*Math.cos(ang-0.4),p1y=y2-sz*Math.sin(ang-0.4);
  const p2x=x2-sz*Math.cos(ang+0.4),p2y=y2-sz*Math.sin(ang+0.4);
  return`${x2},${y2} ${p1x},${p1y} ${p2x},${p2y}`;
}

function render(){
  const svg=document.getElementById("dag-svg");
  svg.innerHTML="";
  const order=topoSort();
  const alive=cull(order);

  // Draw edges
  edges.forEach((e,i)=>{
    const g=document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute("class","edge");
    const p=edgePath(e);
    const hit=document.createElementNS("http://www.w3.org/2000/svg","path");
    hit.setAttribute("d",p.d);hit.setAttribute("class","edge-hit");
    hit.setAttribute("stroke-width","18");hit.setAttribute("stroke","transparent");
    hit.setAttribute("fill","none");
    hit.addEventListener("click",()=>{e.active=!e.active;render()});
    const path=document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d",p.d);
    path.setAttribute("stroke",e.active?COL_EDGE:COL_OFF);
    if(!e.active)path.setAttribute("stroke-dasharray","6 4");
    path.setAttribute("opacity",e.active?"1":"0.4");
    const arrow=document.createElementNS("http://www.w3.org/2000/svg","polygon");
    arrow.setAttribute("points",arrowHead(p.x2,p.y2,p.mx,p.my));
    arrow.setAttribute("fill",e.active?COL_EDGE:COL_OFF);
    arrow.setAttribute("opacity",e.active?"1":"0.4");
    const label=document.createElementNS("http://www.w3.org/2000/svg","text");
    label.setAttribute("x",p.mx);label.setAttribute("y",p.my-8);
    label.setAttribute("class","edge-label");
    label.setAttribute("fill",e.active?COL_EDGE:COL_OFF);
    label.setAttribute("opacity",e.active?"1":"0.5");
    label.textContent=e.label;
    g.append(path,arrow,label,hit);
    svg.append(g);
  });

  // Draw nodes
  passes.forEach(p=>{
    const isAlive=alive.has(p.id);
    const isOutput=p.id===outputId;
    const g=document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute("class","node");
    const r=document.createElementNS("http://www.w3.org/2000/svg","rect");
    r.setAttribute("x",p.x);r.setAttribute("y",p.y);
    r.setAttribute("width",NW);r.setAttribute("height",NH);
    r.setAttribute("fill",isOutput?COL_OUTPUT:isAlive?COL_ALIVE:COL_DEAD);
    r.setAttribute("stroke",isOutput?"var(--ds-warn-dark)":isAlive?"var(--ds-success-dark)":"#4b5563");
    r.setAttribute("opacity",isAlive?"1":"0.4");
    const t=document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x",cx(p));t.setAttribute("y",cy(p));
    t.textContent=isAlive?p.name:p.name+" âœ—";
    t.setAttribute("opacity",isAlive?"1":"0.5");
    g.append(r,t);svg.append(g);
  });

  document.getElementById("dag-topo").textContent=
    order.filter(i=>alive.has(i)).map(i=>passes.find(p=>p.id===i).name).join(" â†’ ")||"(empty)";
  document.getElementById("dag-active").textContent=alive.size;

  const info=document.getElementById("dag-explain");
  const disabled=edges.filter(e=>!e.active);
  const culled=passes.filter(p=>!alive.has(p.id));
  if(disabled.length===0){
    info.innerHTML="All edges active â€” every pass reaches the output. <strong>Click an edge</strong> to break a dependency and see which passes get culled.";
  }else if(alive.size===0){
    info.innerHTML="<strong style='color:var(--ds-danger)'>Output node disconnected!</strong> Nothing renders. The graph compiler would flag this as an error.";
  }else if(culled.length>0){
    info.innerHTML="<strong>"+culled.map(p=>p.name).join(", ")+"</strong> culled â€” "+(culled.length===1?"its output is":"their outputs are")+" no longer consumed by any path to the final output. The compiler skips "+(culled.length===1?"this pass":"these passes")+" and frees their resources.";
  }else{
    info.innerHTML="Edges disabled but all passes still reachable through alternate paths. The topological order may change.";
  }
}

window.dagSetExample=function(idx){loadExample(idx)};
window.dagReset=function(){loadExample(curExample)};
loadExample(0);
})();
</script>
