<script>
(function(){
  if(typeof IntersectionObserver==='undefined')return;

  /* ── Auto-discover diagram elements and add fg-reveal ── */
  var autoSelectors=[
    '.diagram-box','.diagram-bars','.diagram-flow','.diagram-card',
    '.diagram-tree','.diagram-steps','.diagram-bitset','.diagram-tiles',
    '.diagram-warn','.diagram-spectrum','.diagram-phases','.diagram-ftable',
    '.diagram-struct'
  ];
  autoSelectors.forEach(function(sel){
    document.querySelectorAll(sel).forEach(function(el){
      if(!el.classList.contains('fg-reveal'))el.classList.add('fg-reveal');
    });
  });

  /* ── Observe all fg-reveal and fg-compare elements ── */
  var observer=new IntersectionObserver(function(entries){
    entries.forEach(function(e){
      if(e.isIntersecting){
        e.target.classList.add('visible');
        observer.unobserve(e.target);
      }
    });
  },{threshold:0.12,rootMargin:'0px 0px -30px 0px'});

  document.querySelectorAll('.fg-reveal,.fg-compare,.fg-connector,.fg-grid-stagger').forEach(function(el){
    observer.observe(el);
  });
})();
</script>

<script>
/* ═══ Site-wide Navigation ═══════════════════════════════════════════
   Progress bar + breadcrumbs + TOC rail for every page.
   Skips automatically when article-nav shortcode is present.
   ═══════════════════════════════════════════════════════════════════ */
(function(){
  /* If article-nav is already active, it handles everything */
  if (document.getElementById('anav-top')) return;

  function init() {
    /* ── Breadcrumbs from URL ─────────────────────────────────────── */
    var baseMeta = document.querySelector('meta[name="snav-base"]');
    var basePath = baseMeta ? baseMeta.content.replace(/\/$/,'') : '';
    var rawPath  = location.pathname;
    if (basePath && rawPath.indexOf(basePath) === 0) rawPath = rawPath.substring(basePath.length);
    var path = rawPath.replace(/^\/|\/$/g, '');
    var segments = path ? path.split('/') : [];

    var h1El = document.querySelector('article h1') ||
               document.querySelector('main h1') ||
               document.querySelector('h1');
    var pageTitle = h1El
      ? h1El.textContent.trim()
      : document.title.split('|')[0].split('·')[0].trim();

    var niceNames = {
      posts:'Posts', about:'About', tags:'Tags',
      categories:'Categories', series:'Series', authors:'Authors'
    };

    var crumbs = [{ name: 'Deep Spark', url: basePath + '/' }];
    for (var i = 0; i < segments.length; i++) {
      var seg = segments[i];
      var isLast = i === segments.length - 1;
      if (isLast) {
        crumbs.push({
          name: segments.length === 1
            ? (niceNames[seg] || pageTitle)
            : pageTitle,
          url: null
        });
      } else {
        crumbs.push({
          name: niceNames[seg] || seg.charAt(0).toUpperCase() + seg.slice(1),
          url: basePath + '/' + segments.slice(0, i + 1).join('/') + '/'
        });
      }
    }

    /* ── Scan headings for TOC ────────────────────────────────────── */
    var article = document.querySelector('article') ||
                  document.querySelector('.prose') ||
                  document.querySelector('main');
    var rawH = article ? article.querySelectorAll('h2, h3') : [];
    var tocItems = [];
    rawH.forEach(function(h) {
      var text = h.textContent.trim();
      if (text.length < 2) return;
      if (!h.id) h.id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/, '');
      tocItems.push({ name: text, el: h, id: h.id, level: parseInt(h.tagName.charAt(1)) });
    });
    var hasToc = tocItems.length >= 3;

    /* ── Build DOM ────────────────────────────────────────────────── */
    var html = '<div class="snav-top" id="snav-top">' +
      '<div class="snav-progress-track"><div class="snav-progress-bar" id="snav-progress-bar"></div></div>' +
      '<div class="snav-breadcrumb">';

    crumbs.forEach(function(c, i) {
      if (i > 0) html += '<span class="snav-bc-sep">\u203a</span>';
      if (c.url) {
        html += '<span class="snav-bc-item"><a href="' + c.url + '">' + c.name + '</a></span>';
      } else {
        html += '<span class="snav-bc-current" id="snav-bc-current">' + c.name + '</span>';
      }
    });
    if (hasToc) {
      html += '<span class="snav-bc-sep">\u203a</span>';
      html += '<span class="snav-bc-section" id="snav-bc-section">\u2014</span>';
    }
    html += '<span class="snav-bc-pct" id="snav-bc-pct">0%</span>';
    html += '</div></div>';

    /* Side rail */
    if (hasToc) {
      html += '<div class="snav-rail" id="snav-rail"><div class="snav-rail-inner" id="snav-rail-inner">' +
        '<div class="snav-rail-title">On this page</div>' +
        '<div class="snav-rail-items" id="snav-rail-items">';
      tocItems.forEach(function(item) {
        var indent = item.level === 3 ? ' style="padding-left:1.8em;font-size:.9em;opacity:.8"' : '';
        var sName = item.name.length > 30 ? item.name.substring(0, 30) + '\u2026' : item.name;
        html += '<div class="snav-rail-link" data-target="' + item.id + '"' + indent + '>' + sName + '</div>';
      });
      html += '</div><div class="snav-rail-pct-bottom" id="snav-rail-pct">0% read</div></div></div>';
      html += '<div class="snav-mobile-backdrop" id="snav-mobile-backdrop"></div>';
      html += '<button class="snav-mobile-fab" id="snav-mobile-fab" aria-label="Open navigation">\u2630</button>';
    }

    var tmp = document.createElement('div');
    tmp.innerHTML = html;
    while (tmp.firstChild) document.body.appendChild(tmp.firstChild);

    /* ── References ───────────────────────────────────────────────── */
    var topEl      = document.getElementById('snav-top');
    var barEl      = document.getElementById('snav-progress-bar');
    var bcSection  = document.getElementById('snav-bc-section');
    var bcPct      = document.getElementById('snav-bc-pct');
    var railEl     = document.getElementById('snav-rail');
    var railPctEl  = document.getElementById('snav-rail-pct');
    var railItemsE = document.getElementById('snav-rail-items');
    var bcCurEl    = document.getElementById('snav-bc-current');

    /* ── Rail click → smooth scroll ───────────────────────────────── */
    if (railItemsE) {
      railItemsE.querySelectorAll('[data-target]').forEach(function(el) {
        el.addEventListener('click', function() {
          var t = document.getElementById(el.getAttribute('data-target'));
          if (t) { t.scrollIntoView({ behavior:'smooth', block:'start' }); closeMobile(); }
        });
      });
    }

    /* Breadcrumb current → scroll to top */
    if (bcCurEl) bcCurEl.addEventListener('click', function() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    /* ── Mobile FAB & backdrop ────────────────────────────────────── */
    var fab = document.getElementById('snav-mobile-fab');
    var bkd = document.getElementById('snav-mobile-backdrop');

    function openMobile()  { if(railEl) railEl.classList.add('snav-rail-open'); if(bkd) bkd.classList.add('active'); if(fab) fab.textContent='\u2715'; }
    function closeMobile() { if(railEl) railEl.classList.remove('snav-rail-open'); if(bkd) bkd.classList.remove('active'); if(fab) fab.textContent='\u2630'; }

    if (fab) fab.addEventListener('click', function() {
      railEl.classList.contains('snav-rail-open') ? closeMobile() : openMobile();
    });
    if (bkd) bkd.addEventListener('click', closeMobile);

    /* Swipe-down to close mobile rail */
    if (hasToc) {
      var railInner = document.getElementById('snav-rail-inner');
      var startY = 0;
      railInner.addEventListener('touchstart', function(e){ startY = e.touches[0].clientY; }, { passive:true });
      railInner.addEventListener('touchend', function(e){
        if (e.changedTouches[0].clientY - startY > 60 && railInner.scrollTop <= 0) closeMobile();
      }, { passive:true });
    }

    /* ── Scroll tracking ──────────────────────────────────────────── */
    var ticking = false;
    function onScroll() {
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(function() {
        ticking = false;
        var scrollY  = window.scrollY || window.pageYOffset;
        var docH     = document.documentElement.scrollHeight - window.innerHeight;
        var pct      = docH > 0 ? Math.min(100, Math.round(scrollY / docH * 100)) : 0;
        var show     = scrollY > 150;

        topEl.classList.toggle('visible', show);
        document.body.classList.toggle('snav-active', show);
        if (railEl) railEl.classList.toggle('visible', show);

        barEl.style.width = pct + '%';
        bcPct.textContent = pct + '%';
        if (railPctEl) railPctEl.textContent = pct + '% read';

        /* Scrollspy */
        if (hasToc) {
          var cur = null;
          for (var i = tocItems.length - 1; i >= 0; i--) {
            if (tocItems[i].el.getBoundingClientRect().top <= 80) { cur = tocItems[i]; break; }
          }
          if (cur) {
            bcSection.textContent = cur.name;
            railItemsE.querySelectorAll('.snav-rail-link').forEach(function(el){ el.classList.remove('active'); });
            var active = railItemsE.querySelector('[data-target="' + cur.id + '"]');
            if (active) {
              active.classList.add('active');
              var ri = document.getElementById('snav-rail-inner');
              var lr = active.getBoundingClientRect(), rr = ri.getBoundingClientRect();
              if (lr.bottom > rr.bottom || lr.top < rr.top) active.scrollIntoView({ block:'nearest' });
            }
          } else {
            bcSection.textContent = '\u2014';
          }
        }
      });
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    setTimeout(onScroll, 100);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

<!-- Auto-hide sidebar TOC when it touches/overlaps content -->
<script>
(function () {
  if (typeof ResizeObserver === 'undefined') return;

  // The outer wrapper that holds the sidebar TOC
  var tocOuter = document.querySelector('.toc-right');
  if (!tocOuter) tocOuter = document.querySelector('.toc');
  var sidebarWrap = tocOuter && tocOuter.closest('div.order-first');
  var contentWrap = document.querySelector('.article-content');
  if (!sidebarWrap || !contentWrap) return;

  var raf = null;

  function check() {
    raf = null;

    // Temporarily reveal sidebar so we can measure real positions
    var wasHidden = document.body.classList.contains('toc-sidebar-hidden');
    if (wasHidden) document.body.classList.remove('toc-sidebar-hidden');

    var contentRect = contentWrap.getBoundingClientRect();
    var sidebarRect = sidebarWrap.getBoundingClientRect();

    // The sidebar overlaps/touches if its left edge <= content's right edge
    // (with a small 8px gap tolerance)
    var overlaps = sidebarRect.left < contentRect.right + 8;

    if (overlaps) {
      document.body.classList.add('toc-sidebar-hidden');
    } else {
      document.body.classList.remove('toc-sidebar-hidden');
    }
  }

  function scheduleCheck() {
    if (!raf) raf = requestAnimationFrame(check);
  }

  // Watch for size changes on both the content and viewport
  var ro = new ResizeObserver(scheduleCheck);
  ro.observe(contentWrap);
  ro.observe(sidebarWrap);
  ro.observe(document.documentElement);

  // Also recheck on window resize (catches zoom, orientation, etc.)
  window.addEventListener('resize', scheduleCheck, { passive: true });

  check(); // initial run
})();
</script>


